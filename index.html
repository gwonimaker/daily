<!doctype html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&family=Inter:wght@400;600;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ìà¨Ïûê Í∏∞Î°ù</title>
  <style>
    :root{
  --bg:#f8fafc;
  --bg2:#eef2ff;
  --panel:#ffffff;
  --panel2:#f1f5f9;
  --text:#1e293b;
  --muted:#64748b;
  --border:#e2e8f0;
  --shadow: 0 12px 28px rgba(15,23,42,.08);
  --radius:18px;

  --accent:#a5b4fc;      /* pastel indigo */
  --accent-strong:#818cf8;
  --mint:#99f6e4;        /* pastel mint */
  --rose:#fecdd3;        /* pastel rose */

  --ok:#10b981;
  --bad:#ef4444;
}
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, var(--bg2) 0%, var(--bg) 22%);
      color:var(--text);
      font-family: "Inter","Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      overflow:hidden;
    }
    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background:var(--panel);
      flex:0 0 auto;
    }
    .title{
      font-weight:900;
      letter-spacing:-0.2px;
      font-size:20px; font-family:"DM Serif Display", serif; letter-spacing:-.4px;
      margin:0;
      white-space:nowrap;
    }
    .top-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
  cursor:pointer;
  border:1px solid var(--border);
  background:var(--panel2);
  color:var(--text);
  padding:10px 14px;
  border-radius:16px;
  font-weight:600;
  font-size:13px;
  letter-spacing:.2px;
  transition: all .15s ease;
}
button:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 20px rgba(15,23,42,.08);
}
button:active{
  transform: translateY(0);
}
button.primary{
      background:var(--accent);
      border-color:var(--accent-strong);
      color:#1e1b4b;
      font-weight:800;
    }
    button.primary:hover{
      background: linear-gradient(180deg, rgba(47,107,255,.92) 0%, rgba(31,79,214,.95) 100%);
      border-color: rgba(47,107,255,.85);
      box-shadow: 0 16px 30px rgba(31,79,214,.22);
    }
    button.danger{
      background:var(--rose);
      border-color:#fda4af;
      color:#7f1d1d;
      font-weight:700;
    }
    button.danger:hover{
      background: linear-gradient(180deg, rgba(217,48,37,.98), rgba(160,20,12,1));
      border-color: rgba(217,48,37,.78);
      box-shadow: 0 16px 30px rgba(217,48,37,.18);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    .layout{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: minmax(360px, 500px) 1fr;
      gap:12px;
      padding:12px 16px 16px;
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .app{height:auto; overflow:visible}
      .layout{grid-template-columns:1fr; min-height:auto}
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow2);
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;

.card .hd{
  position:relative;
}
.card .hd::after{
  content:"";
  position:absolute;
  left:12px;
  right:12px;
  bottom:-1px;
  height:2px;
  background: linear-gradient(90deg, rgba(47,107,255,.55), rgba(47,107,255,0));
  pointer-events:none;
}

      border-bottom:1px solid var(--border);
      background:var(--panel2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size:12px;
      font-weight:900;
      letter-spacing:-0.2px;
      color:var(--text);
      white-space:nowrap;
    }
    .card .bd{
      padding:12px;
      min-height:0;
    }
    .left .bd{overflow:auto}
    .right .bd{overflow:hidden; display:flex; flex-direction:column; gap:8px}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .field label{
      display:block;
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(47,107,255,.45);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12);
    }
    .row{
      display:grid;
      grid-template-columns: auto 1.2fr .7fr 1fr auto;
      gap:8px;
      align-items:center;
    }
    .row + .row{margin-top:8px}
    .row button{
      padding:9px 10px;
      border-radius:12px;
    }
    .muted{color:var(--muted)}
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .kpi{grid-template-columns:1fr}
    }
    .kpi .box{
      text-align:center;

      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px 12px;
    }
    .kpi .name{font-size:11px; font-weight:900; color:var(--muted); margin-bottom:6px}
    .kpi .val{font-size:20px; font-weight:800; font-family:"Inter",sans-serif; font-weight:1000; letter-spacing:-0.3px}
    .kpi .sub{font-size:11px; color:var(--muted); margin-top:6px}

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      min-height:0;
    }
    @media (max-width: 1200px){
      .charts{grid-template-columns:1fr}
    }
    .chartbox{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px 12px;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .chartbox .ctitle{ font-family:"Pretendard",sans-serif; font-size:13px; letter-spacing:.3px;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin:0 0 8px;
      white-space:nowrap;
    }
    .canvas-wrap{
      position:relative;
      height:260px;
      min-height:160px;
    }
    @media (max-height: 760px){
      .canvas-wrap{height:220px}
    }
    @media (max-height: 660px){
      .canvas-wrap{height:180px}
    }

    .tablewrap{
      flex:1 1 auto;
      min-height:0;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:900px;
    }
    th, td{ font-size:13px;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      font-size:12px;
      vertical-align:top;
      background:#fff;
    }
    
tbody tr:nth-child(even) td{ background:#fbfcff; }
tbody tr:hover td{ background:#f4f7ff; }

    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--panel2);
      font-weight:1000;
      color:var(--muted);
      text-align:left;
      white-space:nowrap;
    }
    td.num, th.num{text-align:right}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      background:var(--panel2);
      padding:6px 10px;
      border-radius:999px; box-shadow: 0 8px 16px rgba(2,6,23,.06);
      font-weight:900;
      font-size:11px;
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(15,157,88,.25); background: rgba(15,157,88,.08); color:#075c34}
    .pill.bad{border-color: rgba(217,48,37,.25); background: rgba(217,48,37,.06); color:#7a1711}

    details{max-width: 520px}
    summary{cursor:pointer; font-weight:900; color:var(--text)}
    .holdings-list{margin:8px 0 0; padding-left:16px; color:var(--muted)}
    .holdings-list li{margin:4px 0}

    .inline-actions{display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap}
    .mini{padding:9px 11px; font-size:11.5px}

    .total-preview{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:12px 12px;
    }
    .total-preview .label{font-size:11px; font-weight:900; color:var(--muted)}
    .total-preview .value{font-size:16px; font-weight:1000; letter-spacing:-0.2px; white-space:nowrap}
    .total-preview .value.bad{color:var(--bad)}
    .fxline{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .fxline input{flex:1 1 auto}
    .fxline button{flex:0 0 auto}
    .hidden{display:none !important}

    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.42);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      background: var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .modal .mh{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      background: var(--panel2);
    }
    .modal .mttl{font-weight:1000; font-size:12px; color:var(--text)}
    .modal .mb{padding:12px}
    .modal .mf{
      padding:12px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
      background:#fff;
    }

    .toast-backdrop{
  position:fixed;
  inset:0;
  background: rgba(2,6,23,.22);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index:999;
  opacity:0;
  transition: opacity .18s ease;
}
.toast-backdrop.show{ opacity:1; }
.toast{
  position:fixed;
  top:50%;
  left:50%;
  transform: translate(-50%, -50%) scale(.98);
  min-width:280px;
  max-width: min(520px, calc(100vw - 32px));
  background: rgba(15,23,42,.92);
  color:#fff;
  padding:16px 18px;
  border-radius:18px;
  font-weight:900;
  font-size:14px;
  box-shadow: 0 34px 70px rgba(2,6,23,.34);
  z-index:1000;
  white-space:pre-wrap;
  text-align:center;
  opacity:0;
  transition: opacity .18s ease, transform .18s ease, background .18s ease;
  border: 1px solid rgba(255,255,255,.12);
}
.toast.show{
  opacity:1;
  transform: translate(-50%, -50%) scale(1);
}
.toast.ok{
  background: rgba(16,185,129,.92);
}
.toast.bad{
  background: rgba(217,48,37,.92);
}
  
/* --- Emotional theme polish --- */
body{
  background:
    radial-gradient(1200px 600px at 10% 0%, rgba(165,180,252,.55), rgba(255,255,255,0) 55%),
    radial-gradient(1000px 520px at 90% 10%, rgba(153,246,228,.45), rgba(255,255,255,0) 60%),
    radial-gradient(900px 520px at 50% 100%, rgba(254,205,211,.45), rgba(255,255,255,0) 55%),
    linear-gradient(180deg, var(--bg2) 0%, var(--bg) 40%, #ffffff 100%);
}
.card{
  border-color: rgba(226,232,240,.85);
  box-shadow: 0 24px 60px rgba(15,23,42,.12);
}
.topbar{
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,.75);
}
.card .hd{
  background: linear-gradient(180deg, rgba(241,245,249,.95), rgba(255,255,255,.90));
}
.card .hd::after{
  height:3px;
  background: linear-gradient(90deg, rgba(129,140,248,.65), rgba(153,246,228,.40), rgba(254,205,211,.40), rgba(255,255,255,0));
}
.kpi .box{
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(241,245,249,.70));
  border-color: rgba(226,232,240,.90);
}
.kpi .name{
  letter-spacing:.3px;
  text-transform: none;
}
.kpi .val{
  line-height:1.15;
}
.chartbox{
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(241,245,249,.72));
}
.canvas-wrap{
  border-radius: 14px;
}
input, select, textarea{
  background: rgba(255,255,255,.90);
}
input::placeholder{ color: rgba(100,116,139,.70); }

/* Make primary/rose buttons feel softer */
button.primary{
  background: linear-gradient(180deg, rgba(165,180,252,.92), rgba(129,140,248,.85));
  border-color: rgba(129,140,248,.65);
  color:#0f172a;
}
button.danger{
  background: linear-gradient(180deg, rgba(254,205,211,.92), rgba(253,164,175,.85));
  border-color: rgba(253,164,175,.70);
  color:#7f1d1d;
}

/* Dashboard table: center align everything */
table{ min-width: 960px; }
th, td{ text-align:center; }
td.num, th.num{ text-align:center; }
.inline-actions{ justify-content:center; }


    th, td{
      vertical-align: middle !important;
    }


.drag{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border:1px solid var(--border);
  background: rgba(255,255,255,.85);
  border-radius:14px;
  width:40px;
  height:40px;
  font-weight:1000;
  color: var(--muted);
  cursor: grab;
  user-select:none;
}
.drag:active{ cursor: grabbing; }
.row.dragging{
  opacity:.65;
  transform: scale(.995);
}
.row.drop-target{
  outline: 2px dashed rgba(129,140,248,.55);
  outline-offset: 4px;
  border-radius:14px;
}


button#addHoldingBtn{
  background: linear-gradient(180deg, rgba(16,185,129,.95), rgba(5,150,105,.98));
  border-color: rgba(16,185,129,.70);
  color: #ffffff;
  font-weight: 900;
}
button#addHoldingBtn:hover{
  background: linear-gradient(180deg, rgba(16,185,129,1), rgba(4,120,87,1));
  border-color: rgba(5,150,105,.85);
}



/* === Force white text + subtle text shadow for primary & danger === */
button.primary,
button#saveBtn{
  color: #ffffff !important;
  text-shadow: 0 1px 2px rgba(0,0,0,.18);
}

button.danger,
button#clearAllBtn{
  color: #ffffff !important;
  text-shadow: 0 1px 2px rgba(0,0,0,.18);
}


/* Drive status pill */
.drivepill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
}
.drivepill .dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background: rgba(148,163,184,.9);
  box-shadow: 0 0 0 3px rgba(148,163,184,.18);
}
.drivepill.connected .dot{
  background: rgba(16,185,129,.95);
  box-shadow: 0 0 0 3px rgba(16,185,129,.18);
}
.drivepill.needs .dot{
  background: rgba(245,158,11,.95);
  box-shadow: 0 0 0 3px rgba(245,158,11,.18);
}

/* === Mobile responsiveness polish === */
@media (max-width: 560px){
  .topbar{
    flex-direction: column;
    align-items: flex-start;
    gap:10px;
    padding:12px 12px;
  }
  .top-actions{
    width:100%;
    justify-content:flex-start;
    gap:8px;
  }
  .top-actions button{
    flex: 1 1 auto;
    text-align:center;
  }

  .layout{
    padding:10px 12px 14px;
    gap:10px;
  }

  .card .bd{ padding:10px; }
  .grid2{ grid-template-columns: 1fr; }

  .kpi{ grid-template-columns: 1fr; }

  .charts{ grid-template-columns: 1fr; }
  .canvas-wrap{ height:200px; min-height:160px; }

  /* Let right panel scroll naturally on mobile */
  .right .bd{ overflow:auto; }

  /* Table: keep scroll inside container and reduce min width */
  table{ min-width: 720px; }
}

/* Extra small screens */
@media (max-width: 380px){
  .title{ font-size:18px; }
  button{ padding:9px 10px; }
  .canvas-wrap{ height:180px; }
  table{ min-width: 680px; }
}

/* Ensure date column centered */
table thead th:first-child,
table tbody td:first-child{
  text-align:center !important;
}

/* Better responsiveness on smaller desktop windows */
@media (max-width: 1200px){
  .layout{
    grid-template-columns: 1fr; /* stack panels */
  }
  .left .bd{ max-height: none; }
  .right .bd{ overflow:auto; }
  .charts{ grid-template-columns: 1fr; }
  .canvas-wrap{ height:220px; }
  table{ min-width: 760px; }
}
@media (max-width: 900px){
  .layout{ padding:10px 12px 14px; }
  table{ min-width: 720px; }
}

/* === Strong chart resize override (responds to window width/height) === */
.charts{ align-items: stretch; }
.chartbox{ min-height:0; display:flex; flex-direction:column; }
.chartbox .canvas-wrap{
  /* width-driven height so shrinking window reduces chart size */
  height: clamp(160px, 28vw, 320px) !important;
  min-height: 150px !important;
  max-height: 340px !important;
}
/* If viewport height is small, cap further */
@media (max-height: 760px){
  .chartbox .canvas-wrap{ height: clamp(150px, 24vw, 260px) !important; }
}
@media (max-height: 660px){
  .chartbox .canvas-wrap{ height: clamp(140px, 22vw, 230px) !important; }
}
/* Mobile: keep comfortable */
@media (max-width: 560px){
  .chartbox .canvas-wrap{ height: clamp(170px, 40vw, 260px) !important; }
}

.holdings-list{
  padding-left:0 !important;
  list-style-position: inside;
  text-align:center !important;
}



/* === Holdings header/value perfect center alignment (force) === */
td:nth-child(7){ text-align:center !important; }
td:nth-child(7) details{
  display:block !important;
  width:100% !important;
  text-align:center !important;
}
td:nth-child(7) summary{
  display:flex !important;
  width:100% !important;
  align-items:center !important;
  justify-content:center !important;
  gap:0 !important;
  margin:0 auto !important;
  list-style:none !important;
  text-align:center !important;
}
td:nth-child(7) summary::-webkit-details-marker{ display:none !important; }
td:nth-child(7) summary::marker{ content:"" !important; }
td:nth-child(7) summary::before{ content:"" !important; display:none !important; }
td:nth-child(7) .holdings-list{
  width:100% !important;
  padding-left:0 !important;
  margin:8px 0 0 !important;
  text-align:center !important;
  list-style-position: inside;
}

/* === Force table header alignment (override sticky header defaults) === */
table thead th{ text-align:center !important; }
table thead th:nth-child(7){ text-align:center !important; } /* 'ÏòàÏπò ÌòÑÌô©' */

/* === Column 7: remove horizontal padding so header/body share identical center axis === */
table thead th:nth-child(7),
table tbody td:nth-child(7){
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* === Fix: details max-width was constraining holdings cell and shifting center === */
td:nth-child(7) details{
  max-width: none !important;
}

/* ===== Galaxy Fold / tablet aspect-safe charts ===== */
@media (max-width: 980px){
  .charts{ grid-template-columns: 1fr !important; }
}

/* Use aspect-ratio to avoid "squished" charts on unusual aspect devices */
.chartbox{ display:flex; flex-direction:column; }
.chartbox .canvas-wrap{
  width:100% !important;
  height:auto !important;
  aspect-ratio: 16 / 9;
  min-height: 220px;
  max-height: 460px;
}

/* Fold-like widths with low height: keep readable */
@media (max-height: 720px){
  .chartbox .canvas-wrap{
    aspect-ratio: 16 / 8;
    min-height: 180px;
    max-height: 360px;
  }
}

/* Narrow but tall devices */
@media (max-width: 560px){
  .chartbox .canvas-wrap{
    aspect-ratio: 4 / 3;
    min-height: 240px;
    max-height: 420px;
  }
}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <h1 class="title">Ìà¨Ïûê Í∏∞Î°ù</h1>
    <div class="top-actions">
      <button id="driveBtn" class="mini">‚òÅ Drive</button>
      <button id="exportBtn" class="mini">üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      <button id="importBtn" class="mini">üì• Í∞ÄÏ†∏Ïò§Í∏∞</button>
      <input id="importFile" type="file" accept=".json" class="hidden" />
    </div>
  </div>

  <div class="layout">
    <div class="card left">
      <div class="hd">
        <h2>ÏûÖÎ†•</h2>
        <div class="inline-actions">
          <button id="prevBtn" class="mini">‚è™ Ï†ÑÏùº Î∂àÎü¨Ïò§Í∏∞</button>
          <button id="resetFormBtn" class="mini">Ï¥àÍ∏∞Ìôî</button>
        </div>
      </div>
      <div class="bd">
        <div class="grid2">
          <div class="field">
            <label>ÎÇ†Ïßú</label>
            <input id="date" type="date" />
          </div>
          <div class="field" id="fxField">
            <label>USDT/KRW Ï¢ÖÍ∞Ä</label>
            <div class="fxline">
              <input id="fx" type="number" inputmode="decimal" placeholder="ÏûêÎèô" />
              <button id="fxBtn" class="mini">ÏûêÎèô</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="muted" style="font-size:11px; font-weight:900;">ÏòàÏπò ÌòÑÌô©</div>
          
        </div>
        <div id="holdings"></div>

        <div class="total-preview" style="margin-top:12px;">
          <div>
            <div class="label">Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°(KRW)</div>
            <div class="muted" id="totalSub" style="font-size:11px; margin-top:6px;"></div>
          </div>
          <div id="totalPreview" class="value">‚Äî</div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="addHoldingBtn" class="mini">Ôºã Ìï≠Î™© Ï∂îÍ∞Ä</button>
          <button id="saveBtn" class="primary">üíæ Ï†ÄÏû•</button>
          <button id="cancelEditBtn" class="mini hidden">Ìé∏Ïßë Ï∑®ÏÜå</button>
          <button id="clearAllBtn" class="danger">üóë Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
        </div>
      </div>
    </div>

    <div class="card right">
      <div class="hd">
        <h2>ÎåÄÏãúÎ≥¥Îìú</h2>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <div class="name">ÏµúÍ∑º Ï¥ùÏï°</div>
            <div class="val" id="kpiTotal">‚Äî</div>
            <div class="sub" id="kpiDate">‚Äî</div>
          </div>
          <div class="box">
            <div class="name">ÏùºÏùº Î≥ÄÎèô</div>
            <div class="val" id="kpiDelta">‚Äî</div>
            <div class="sub" id="kpiDeltaPct">‚Äî</div>
          </div>
          <div class="box">
            <div class="name">Ï¥ù ÎàÑÏ†Å Î≥ÄÎèô</div>
            <div class="val" id="kpiCum">‚Äî</div>
            <div class="sub" id="kpiCumPct">‚Äî</div>
          </div>
        </div>

        <div class="charts" id="chartsBox">
          <div class="chartbox">
            <div class="ctitle">Ï¥ùÏï° Ï∂îÏù¥ (KRW)</div>
            <div class="canvas-wrap"><canvas id="chartTotal"></canvas></div>
          </div>
<div class="chartbox">
            <div class="ctitle">ÎàÑÏ†Å Î≥ÄÎèôÎ•†</div>
            <div class="canvas-wrap"><canvas id="chartDaily"></canvas></div>
          </div>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
  <tr>
    <th style="width:110px;">ÎÇ†Ïßú</th>
    <th class="num" style="width:140px;">Ï¥ùÏï°(KRW)</th>
    <th class="num" style="width:140px;">ÏßÅÏ†Ñ ÎåÄÎπÑ Î≥ÄÎèô</th>
    <th class="num" style="width:120px;">ÏßÅÏ†Ñ ÎåÄÎπÑ Î≥ÄÎèôÎ•†</th>
    <th class="num" style="width:120px;">Ï¥ù ÎàÑÏ†Å Î≥ÄÎèôÎ•†</th>
    <th class="num" style="width:120px;">USDT/KRW</th>
    <th>ÏòàÏπò ÌòÑÌô©</th>
    <th class="num" style="width:160px;">Í¥ÄÎ¶¨</th>
  </tr>
</thead>
            <tbody id="tbody">
              <tr><td colspan="8" class="muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>


<div id="driveModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Google Í≥ÑÏ†ï Ïó∞Í≤∞">
  <div class="modal">
    <div class="mh">
      <div class="mttl">Google Í≥ÑÏ†ï Ïó∞Í≤∞</div>
      <button id="driveCloseBtn" class="mini">Îã´Í∏∞</button>
    </div>
    <div class="mb">
      
      <div id="driveStatus" class="muted" style="font-size:11px; font-weight:900; margin-top:10px;">‚Äî</div>
    </div>
    <div class="mf">
      <button id="driveConnectBtn" class="primary mini">Ïó∞Í≤∞</button>
      <button id="driveLoadBtn" class="mini">Î∂àÎü¨Ïò§Í∏∞</button>
      <button id="driveSaveBtn" class="mini">Drive Ï†ÄÏû•</button>
      <button id="driveDisconnectBtn" class="mini danger">Ïó∞Í≤∞ Ìï¥Ï†ú</button>
    </div>
  </div>
</div>

<div id="toastBackdrop" class="toast-backdrop hidden"></div>

<div id="toast" class="toast hidden"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
<script>
(() => {
  "use strict";

  /*****************
   * Storage
   *****************/
  const STORAGE_KEY_V4 = "investTrackerData.v4";
  const LEGACY_KEYS = ["investTrackerData.v3", "investTrackerData.v2", "investTrackerData.v1"];

  /*****************
   * State
   *****************/
  /**
   * Entry(v4)
   * {
   *   date: "YYYY-MM-DD",
   *   fx: number|null, // KRW per 1 USDT (only if needed)
   *   holdings: Array<{ where: string, ccy: "KRW"|"USDT", amount: number }>,
   *   totalKrw: number
   * }
   */
  let entries = [];
  let editDate = null;
  let fxCache = {}; // {"YYYY-MM-DD": number}

  /*****************
   * Drive Sync (optional)
   *****************/
  const DRIVE_KEY = "investTrackerDrive.v1";
  const DRIVE_FILE_NAME = "invest-tracker.json";
  const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";

  let driveCfg = { clientId: "210029436571-ppf3577p25dbv4t1l73t94io3h68vq71.apps.googleusercontent.com", fileId: "", enabled: false };
  let driveAccessToken = null;
  let driveTokenExpiresAt = 0;
  let driveTokenClient = null;


  /*****************
   * Utils
   *****************/
  const $ = (id) => document.getElementById(id);

  const toast = (msg, kind="ok", ms=2200) => {
  const el = $("toast");
  const bd = $("toastBackdrop");
  if (!el) return;

  el.textContent = String(msg ?? "");
  el.classList.remove("hidden", "ok", "bad", "show");
  el.classList.add(kind === "bad" ? "bad" : "ok");

  if (bd){
    bd.classList.remove("hidden");
    // trigger transition
    requestAnimationFrame(() => bd.classList.add("show"));
  }

  // trigger transition
  requestAnimationFrame(() => el.classList.add("show"));

  window.clearTimeout(toast._t);
  toast._t = window.setTimeout(() => {
    el.classList.remove("show");
    if (bd) bd.classList.remove("show");

    window.clearTimeout(toast._t2);
    toast._t2 = window.setTimeout(() => {
      el.classList.add("hidden");
      if (bd) bd.classList.add("hidden");
    }, 220);
  }, ms);
};


  const loadDriveCfg = () => {
    try{
      const raw = localStorage.getItem(DRIVE_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      driveCfg = {
        clientId: String(obj?.clientId ?? "").trim(),
        fileId: String(obj?.fileId ?? "").trim(),
        enabled: Boolean(obj?.enabled),
      };
    }catch(_){}
  };

  const saveDriveCfg = () => {
    try{
      localStorage.setItem(DRIVE_KEY, JSON.stringify(driveCfg));
    }catch(_){}
  };

  const driveStatusText = () => {
    if (!driveCfg.clientId) return "ÎØ∏ÏÑ§Ï†ï";
    if (!driveCfg.enabled) return "ÏÑ§Ï†ïÎê®";
    if (driveAccessToken && Date.now() < driveTokenExpiresAt - 30_000) return "Ïó∞Í≤∞Îê®";
    return "Ïó∞Í≤∞ ÌïÑÏöî";
  };

  const refreshDriveUI = () => {
  const st = driveStatusText();

  const pill = $("driveBtn");
  const dot = $("driveDot");
  const lbl = $("driveLabel");

  if (pill){
    pill.classList.remove("connected","needs");
    if (st === "Ïó∞Í≤∞Îê®") pill.classList.add("connected");
    else if (st === "Ïó∞Í≤∞ ÌïÑÏöî") pill.classList.add("needs");
  }
  if (lbl){
    // Minimal label
    lbl.textContent = (st === "Ïó∞Í≤∞Îê®") ? "Drive Ïó∞Í≤∞Îê®" : (st === "Ïó∞Í≤∞ ÌïÑÏöî") ? "Drive Ïó∞Í≤∞ ÌïÑÏöî" : "Drive";
  }

  const stEl = $("driveStatus");
  if (stEl){
    const fid = driveCfg.fileId ? ` ¬∑ ÌååÏùº: ${driveCfg.fileId.slice(0,6)}‚Ä¶` : "";
    stEl.textContent = `ÏÉÅÌÉú: ${st}${fid}`;
  }
};

  const openDriveModal = () => {
    $("driveModal")?.classList.remove("hidden");
    refreshDriveUI();
  };
  const closeDriveModal = () => $("driveModal")?.classList.add("hidden");

  const waitForGIS = () => new Promise((resolve, reject) => {
    let tries = 0;
    const tick = () => {
      if (window.google?.accounts?.oauth2?.initTokenClient) return resolve();
      tries++;
      if (tries > 200) return reject(new Error("Google Ïù∏Ï¶ù ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú Ïã§Ìå®"));
      setTimeout(tick, 50);
    };
    tick();
  });

  const ensureTokenClient = async () => {
    await waitForGIS();
    if (!driveCfg.clientId) throw new Error("OAuth Client ID ÌïÑÏöî");
    if (!driveTokenClient || driveTokenClient.__cid !== driveCfg.clientId){
      driveTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: driveCfg.clientId,
        scope: DRIVE_SCOPE,
        callback: () => {}
      });
      driveTokenClient.__cid = driveCfg.clientId;
    }
  };

  const requestDriveToken = async () => {
    await ensureTokenClient();

    const attempt = (prompt) => new Promise((resolve, reject) => {
      driveTokenClient.callback = (resp) => {
        if (resp && resp.access_token) return resolve(resp);
        reject(new Error(resp?.error || "Ïù∏Ï¶ù Ïã§Ìå®"));
      };
      try{
        driveTokenClient.requestAccessToken({ prompt });
      }catch(e){
        reject(e);
      }
    });

    let resp;
    try{
      resp = await attempt("");
    }catch(_){
      resp = await attempt("consent");
    }

    driveAccessToken = resp.access_token;
    driveTokenExpiresAt = Date.now() + (Number(resp.expires_in || 3600) * 1000);
    driveCfg.enabled = true;
    saveDriveCfg();
    refreshDriveUI();
  };



// Silent token request: tries without forcing consent UI.
// If the browser/Google requires interaction, this throws and the user can click "Ïó∞Í≤∞".
const requestDriveTokenSilent = async () => {
  await ensureTokenClient();
  const resp = await new Promise((resolve, reject) => {
    driveTokenClient.callback = (r) => {
      if (r && r.access_token) return resolve(r);
      reject(new Error(r?.error || "Ïù∏Ï¶ù ÌïÑÏöî"));
    };
    try{
      driveTokenClient.requestAccessToken({ prompt: "" });
    }catch(e){
      reject(e);
    }
  });
  driveAccessToken = resp.access_token;
  driveTokenExpiresAt = Date.now() + (Number(resp.expires_in || 3600) * 1000);
  // Don't flip enabled here; respect saved setting
  refreshDriveUI();
  return driveAccessToken;
};

const autoDriveBootstrap = async () => {
  // Only auto-connect if the user has connected before (enabled) and clientId is present.
  if (!driveCfg.enabled) return;
  if (!driveCfg.clientId) return;

  try{
    await requestDriveTokenSilent();
  }catch(_){
    // No toast: stay quiet; user can connect manually.
    return;
  }

  // Auto-load from Drive (best effort). If no file exists yet, keep local.
  try{
    const obj = await driveDownloadObject();
    importFromObject(obj);
    toast("Drive ÏûêÎèô Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å", "ok");
  }catch(_){
    // Ignore (e.g., file not found yet)
  }
};
  const ensureDriveToken = async () => {
    if (!driveCfg.enabled) throw new Error("Drive ÎØ∏Ïó∞Í≤∞");
    if (!driveCfg.clientId) throw new Error("OAuth Client ID ÌïÑÏöî");
    if (driveAccessToken && Date.now() < driveTokenExpiresAt - 30_000) return driveAccessToken;
    await requestDriveToken();
    return driveAccessToken;
  };

  const driveFetch = async (url, opts = {}, retry = true) => {
    const token = await ensureDriveToken();
    const headers = new Headers(opts.headers || {});
    headers.set("Authorization", `Bearer ${token}`);
    const res = await fetch(url, { ...opts, headers });
    if (res.status === 401 && retry){
      driveAccessToken = null;
      driveTokenExpiresAt = 0;
      return driveFetch(url, opts, false);
    }
    return res;
  };

  const driveFindLatestFileId = async () => {
    const q = `name='${DRIVE_FILE_NAME}' and trashed=false`;
    const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&pageSize=5&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc`;
    const res = await driveFetch(url, { method: "GET" });
    if (!res.ok) throw new Error(`Drive Ï°∞Ìöå Ïã§Ìå® (HTTP ${res.status})`);
    const data = await res.json();
    const f = data?.files?.[0];
    return f?.id ? String(f.id) : "";
  };

  const driveCreateFile = async (contentStr) => {
    const boundary = "-------" + Math.random().toString(16).slice(2);
    const metadata = { name: DRIVE_FILE_NAME, mimeType: "application/json" };
    const multipart = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${contentStr}\r\n--${boundary}--`;
    const url = "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,modifiedTime";
    const res = await driveFetch(url, {
      method: "POST",
      headers: { "Content-Type": `multipart/related; boundary=${boundary}` },
      body: multipart
    });
    if (!res.ok) throw new Error(`Drive ÏÉùÏÑ± Ïã§Ìå® (HTTP ${res.status})`);
    return await res.json();
  };

  const driveUpdateFile = async (fileId, contentStr) => {
    const url = `https://www.googleapis.com/upload/drive/v3/files/${encodeURIComponent(fileId)}?uploadType=media`;
    const res = await driveFetch(url, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: contentStr
    });
    if (!res.ok) throw new Error(`Drive Ï†ÄÏû• Ïã§Ìå® (HTTP ${res.status})`);
    try{ return await res.json(); }catch(_){ return {}; }
  };

  const buildDrivePayload = () => ({ version: 4, savedAt: new Date().toISOString(), entries, fxCache });

  const driveUploadLocal = async (silent=false) => {
    if (!driveCfg.enabled) return false;
    try{
      const contentStr = JSON.stringify(buildDrivePayload());
      let fileId = driveCfg.fileId;

      if (!fileId) fileId = await driveFindLatestFileId();

      if (fileId){
        await driveUpdateFile(fileId, contentStr);
        driveCfg.fileId = fileId;
      } else {
        const created = await driveCreateFile(contentStr);
        driveCfg.fileId = String(created?.id ?? "");
      }

      saveDriveCfg();
      refreshDriveUI();
      if (!silent) toast("Drive Ï†ÄÏû• ÏôÑÎ£å", "ok");
      return true;
    }catch(err){
      toast(err?.message ?? "Drive Ï†ÄÏû• Ïã§Ìå®", "bad", 2600);
      return false;
    }
  };

  const driveDownloadObject = async () => {
    if (!driveCfg.enabled) throw new Error("Drive ÎØ∏Ïó∞Í≤∞");
    let fileId = driveCfg.fileId;
    if (!fileId) fileId = await driveFindLatestFileId();
    if (!fileId) throw new Error("Drive ÌååÏùº ÏóÜÏùå");

    const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media`;
    const res = await driveFetch(url, { method: "GET" });
    if (!res.ok) throw new Error(`Drive Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå® (HTTP ${res.status})`);
    const obj = await res.json();

    driveCfg.fileId = fileId;
    saveDriveCfg();
    refreshDriveUI();
    return obj;
  };

  const bindDriveUI = () => {
    $("driveBtn")?.addEventListener("click", openDriveModal);
    $("driveCloseBtn")?.addEventListener("click", closeDriveModal);
    $("driveModal")?.addEventListener("click", (e) => {
      if (e.target && e.target.id === "driveModal") closeDriveModal();
    });

    

    $("driveConnectBtn")?.addEventListener("click", async () => {
      
      if (!driveCfg.clientId){
        toast("OAuth Client ID ÌïÑÏöî", "bad");
        return;
      }
      saveDriveCfg();
      try{
        await requestDriveToken();
        toast("Drive Ïó∞Í≤∞Îê®", "ok");
      }catch(err){
        toast(err?.message ?? "Drive Ïó∞Í≤∞ Ïã§Ìå®", "bad", 2600);
      }
    });

    $("driveDisconnectBtn")?.addEventListener("click", async () => {
      try{
        await waitForGIS();
        if (driveAccessToken && window.google?.accounts?.oauth2?.revoke){
          google.accounts.oauth2.revoke(driveAccessToken, () => {});
        }
      }catch(_){}
      driveAccessToken = null;
      driveTokenExpiresAt = 0;
      driveCfg.enabled = false;
      saveDriveCfg();
      refreshDriveUI();
      toast("Drive Ïó∞Í≤∞ Ìï¥Ï†ú", "ok");
    });

    $("driveSaveBtn")?.addEventListener("click", async () => {
      
      saveDriveCfg();
      await driveUploadLocal(false);
    });

    $("driveLoadBtn")?.addEventListener("click", async () => {
      try{
        const obj = await driveDownloadObject();
        importFromObject(obj);
        toast("Drive Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å", "ok");
        closeDriveModal();
      }catch(err){
        toast(err?.message ?? "Drive Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®", "bad", 2600);
      }
    });
  };

  const nf = new Intl.NumberFormat("ko-KR");
  const fmtKRW = (n) => (Number.isFinite(n) ? `${nf.format(Math.round(n))}Ïõê` : "‚Äî");
  const fmtFX = (n) => (Number.isFinite(n) ? nf.format(n) : "‚Äî");
  const fmtPct = (p) => (Number.isFinite(p) ? `${(p*100).toFixed(2)}%` : "‚Äî");
  const parseNum = (v) => {
    const n = Number(String(v ?? "").replaceAll(",", "").trim());
    return Number.isFinite(n) ? n : NaN;
  };
  const clampStr = (s, max=120) => {
    const t = String(s ?? "").trim();
    return t.length > max ? t.slice(0, max) : t;
  };
  const kstTodayStr = () => {
    // For input default; acceptable without perfect KST conversion here.
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  };
  const addDays = (yyyyMmDd, days) => {
    const [y,m,d] = yyyyMmDd.split("-").map(Number);
    const dt = new Date(Date.UTC(y, (m-1), d));
    dt.setUTCDate(dt.getUTCDate() + days);
    const yy = dt.getUTCFullYear();
    const mm = String(dt.getUTCMonth()+1).padStart(2,'0');
    const dd = String(dt.getUTCDate()).padStart(2,'0');
    return `${yy}-${mm}-${dd}`;
  };

  const shortKRW = (n) => {
    if (!Number.isFinite(n)) return "";
    const a = Math.abs(n);
    const sign = n < 0 ? "-" : "";
    if (a >= 1e12) return sign + (a/1e12).toFixed(1) + "Ï°∞";
    if (a >= 1e8)  return sign + (a/1e8).toFixed(1) + "Ïñµ";
    if (a >= 1e4)  return sign + (a/1e4).toFixed(1) + "Îßå";
    return sign + nf.format(Math.round(a));
  };


  const colorForKey = (key) => {
    const s = String(key ?? "");
    let h = 0;
    for (let i = 0; i < s.length; i++){
      h = (h * 31 + s.charCodeAt(i)) >>> 0;
    }
    const hue = h % 360;
    return `hsl(${hue}, 72%, 52%)`;
  };

  const sortEntriesAsc = (arr) => arr.slice().sort((a,b)=> (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
  const sortEntriesDesc = (arr) => arr.slice().sort((a,b)=> (a.date > b.date ? -1 : a.date < b.date ? 1 : 0));

  /*****************
   * FX (Upbit USDT/KRW close)
   *****************/
  const getUpbitUsdtKrwClose = async (dateStr) => {
    const toDate = addDays(dateStr, 1);
    const to = `${toDate}T00:00:00+09:00`;
    const url = `https://api.upbit.com/v1/candles/days?market=KRW-USDT&to=${encodeURIComponent(to)}&count=1`;
    const res = await fetch(url, { method: "GET", cache: "no-store" });
    if (!res.ok) throw new Error(`ÌôòÏú® Ï°∞Ìöå Ïã§Ìå® (HTTP ${res.status})`);
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) throw new Error("ÌôòÏú® Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå");
    const fx = Number(data[0]?.trade_price);
    if (!Number.isFinite(fx) || fx <= 0) throw new Error("ÌôòÏú® ÌååÏã± Ïã§Ìå®");
    return fx;
  };

// Auto FX: fetch once per date when USDT exists and fx is missing
let fxFetchInFlight = null;
const ensureFxForDateIfNeeded = async (dateStr, force=false) => {
  if (!dateStr) return null;

  // Only if current UI has USDT rows
  if (!uiHasUsdtRow()) return null;

  // If already have cached fx and not forcing, just use it
  if (!force && Number.isFinite(fxCache[dateStr])) {
    if (!$("fx").value) $("fx").value = String(fxCache[dateStr]);
    return fxCache[dateStr];
  }

  // If user typed a manual fx, respect it (and cache it)
  const manual = parseNum($("fx").value);
  if (!force && Number.isFinite(manual) && manual > 0){
    fxCache[dateStr] = manual;
    return manual;
  }

  // Avoid duplicate calls
  if (fxFetchInFlight && fxFetchInFlight.dateStr === dateStr) return fxFetchInFlight.promise;

  const p = (async () => {
    try{
      $("fxBtn").disabled = true;
      const fx = await getUpbitUsdtKrwClose(dateStr);
      fxCache[dateStr] = fx;
      $("fx").value = String(fx);
      updateTotalPreview();
      return fx;
    }catch(_){
      // Keep quiet; user can still enter manually
      return null;
    }finally{
      $("fxBtn").disabled = false;
      fxFetchInFlight = null;
    }
  })();

  fxFetchInFlight = { dateStr, promise: p };
  return p;
};


  const holdingsNeedFx = (holdings) => holdings.some(h => h.ccy === "USDT" && Number.isFinite(h.amount) && h.amount !== 0);

  /*****************
   * DOM: Holdings rows
   *****************/
  const holdingsEl = $("holdings");

  const holdingRowTemplate = (h = {}) => {
    const row = document.createElement("div");
    row.className = "row";
    row.setAttribute("draggable", "true");
    row.innerHTML = `
      <div class="drag" title="ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω">‚ãÆ‚ãÆ</div>
      <input class="where" type="text" placeholder="ÏòàÏπòÏ≤ò" value="${escapeHtml(h.where ?? "")}">
      <select class="ccy">
        <option value="KRW">KRW</option>
        <option value="USDT">USDT</option>
      </select>
      <input class="amt" type="number" inputmode="decimal" placeholder="Í∏àÏï°" value="${Number.isFinite(h.amount) ? String(h.amount) : (h.amount ?? "")}">
      <button class="mini danger rm" title="ÏÇ≠Ï†ú">ÏÇ≠Ï†ú</button>
    `;
    row.querySelector(".ccy").value = (h.ccy === "USDT" ? "USDT" : "KRW");

// Prevent accidental drag from form controls
row.querySelectorAll("input, select, button").forEach(el => el.setAttribute("draggable","false"));


    const onChange = async () => {
      updateFxVisibility();
      const d = $("date").value;
      await ensureFxForDateIfNeeded(d, false);
      updateTotalPreview();
    };
    row.querySelector(".where").addEventListener("input", onChange);
    row.querySelector(".ccy").addEventListener("change", onChange);
    row.querySelector(".amt").addEventListener("input", onChange);
    row.querySelector(".rm").addEventListener("click", () => {
      row.remove();
      updateFxVisibility();
      updateTotalPreview();
    });

// Drag & Drop reorder (only start when dragging the handle)
let canDrag = false;
row.querySelector(".drag").addEventListener("pointerdown", () => { canDrag = true; });
row.querySelector(".drag").addEventListener("pointerup", () => { canDrag = false; });
row.querySelector(".drag").addEventListener("pointercancel", () => { canDrag = false; });

row.addEventListener("dragstart", (ev) => {
  if (!canDrag){
    ev.preventDefault();
    return;
  }
  row.classList.add("dragging");
  ev.dataTransfer.effectAllowed = "move";
  ev.dataTransfer.setData("text/plain", "holding-row");
  // store reference globally
  holdingsEl.__dragging = row;
});

row.addEventListener("dragend", () => {
  row.classList.remove("dragging");
  const targets = holdingsEl.querySelectorAll(".drop-target");
  targets.forEach(t => t.classList.remove("drop-target"));
  holdingsEl.__dragging = null;
  updateFxVisibility();
  updateTotalPreview();
});

row.addEventListener("dragover", (ev) => {
  const dragging = holdingsEl.__dragging;
  if (!dragging || dragging === row) return;
  ev.preventDefault();
  ev.dataTransfer.dropEffect = "move";
  row.classList.add("drop-target");
});

row.addEventListener("dragleave", () => {
  row.classList.remove("drop-target");
});

row.addEventListener("drop", (ev) => {
  ev.preventDefault();
  row.classList.remove("drop-target");
  const dragging = holdingsEl.__dragging;
  if (!dragging || dragging === row) return;

  const rect = row.getBoundingClientRect();
  const before = (ev.clientY - rect.top) < (rect.height / 2);

  if (before){
    holdingsEl.insertBefore(dragging, row);
  } else {
    holdingsEl.insertBefore(dragging, row.nextSibling);
  }
  updateFxVisibility();
  updateTotalPreview();
});

    return row;
  };

  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  const getHoldingsFromUI = () => {
    const rows = Array.from(holdingsEl.querySelectorAll(".row"));
    const holdings = [];
    for (const r of rows) {
      const where = clampStr(r.querySelector(".where").value || "ÎØ∏ÏßÄÏ†ï", 60);
      const ccy = r.querySelector(".ccy").value === "USDT" ? "USDT" : "KRW";
      const amt = parseNum(r.querySelector(".amt").value);
      if (!Number.isFinite(amt) || amt === 0) continue;
      holdings.push({ where, ccy, amount: amt });
    }
    return holdings;
  };

  const setHoldingsToUI = (holdings) => {
    holdingsEl.innerHTML = "";
    (holdings?.length ? holdings : [{where:"", ccy:"KRW", amount:""}]).forEach(h => holdingsEl.appendChild(holdingRowTemplate(h)));
    updateFxVisibility();
    updateTotalPreview();
  };

  const uiHasUsdtRow = () => {
    return Array.from(holdingsEl.querySelectorAll(".row .ccy"))
      .some(sel => (sel.value === "USDT"));
  };

  const updateFxVisibility = () => {
    const need = uiHasUsdtRow();
    $("fxField").classList.toggle("hidden", !need);
    if (!need) $("fx").value = "";
  };

  /*****************
   * Compute total
   *****************/
  const computeTotalKrw = (holdings, fx) => {
    let sum = 0;
    for (const h of holdings) {
      if (h.ccy === "KRW") sum += h.amount;
      else if (h.ccy === "USDT") {
        if (!Number.isFinite(fx) || fx <= 0) return NaN;
        sum += h.amount * fx;
      }
    }
    return sum;
  };

  const updateTotalPreview = () => {
    const dateStr = $("date").value;
    const holdings = getHoldingsFromUI();
    const needFx = holdingsNeedFx(holdings);
    const fxInput = parseNum($("fx").value);
    const fx = needFx ? (Number.isFinite(fxInput) ? fxInput : (fxCache[dateStr] ?? NaN)) : 1;

    const total = computeTotalKrw(holdings, fx);
    const el = $("totalPreview");
    const sub = $("totalSub");

    if (!holdings.length) {
      el.textContent = "‚Äî";
      el.classList.remove("bad");
      sub.textContent = "";
      return;
    }
    if (needFx && !Number.isFinite(fx)) {
      el.textContent = "ÌôòÏú® ÌïÑÏöî";
      el.classList.add("bad");
      sub.textContent = dateStr ? "USDT Ìè¨Ìï®" : "ÎÇ†Ïßú ÏÑ†ÌÉù";
      return;
    }
    el.textContent = fmtKRW(total);
    el.classList.remove("bad");

    if (needFx) sub.textContent = `USDT/KRW: ${fmtFX(fx)}`;
    else sub.textContent = "";
  };

  /*****************
   * Charts (create once)
   *****************/
  let chartTotal = null;
  let chartDaily = null;

// --- Chart resize plumbing (fixes: resize after window drag / split view) ---
const scheduleChartResize = (() => {
  let raf = 0;

  const syncOne = (chart) => {
    try{
      const canvas = chart?.canvas;
      const wrap = canvas?.parentElement;
      if (!canvas || !wrap) return;

      const rect = wrap.getBoundingClientRect();
      const w = Math.max(0, Math.floor(rect.width));
      const h = Math.max(0, Math.floor(rect.height));
      if (!w || !h) return;

      // Force canvas pixel size to match container (prevents stale sizing after window resize)
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      const dpr = window.devicePixelRatio || 1;
      const pw = Math.floor(w * dpr);
      const ph = Math.floor(h * dpr);
      if (canvas.width !== pw) canvas.width = pw;
      if (canvas.height !== ph) canvas.height = ph;

      if (typeof chart.resize === "function") chart.resize(w, h);
      if (typeof chart.update === "function") chart.update("none");
    }catch(_){}
  };

  return () => {
    if (raf) return;
    raf = requestAnimationFrame(() => {
      raf = 0;
      syncOne(chartTotal);
      syncOne(chartDaily);
      // One more tick after layout settles (split view / maximize)
      requestAnimationFrame(() => {
        syncOne(chartTotal);
        syncOne(chartDaily);
      });
    });
  };
})();

const installChartResizeObservers = () => {
  const w1 = $("chartTotal")?.parentElement; // .canvas-wrap
  const w2 = $("chartDaily")?.parentElement; // .canvas-wrap
  const cb = $("chartsBox");

  if (window.ResizeObserver){
    const ro = new ResizeObserver(() => scheduleChartResize());
    if (w1) ro.observe(w1);
    if (w2) ro.observe(w2);
    if (cb) ro.observe(cb);
    // Observe the right panel as well (some layouts change only there)
    const rb = document.querySelector(".card.right .bd");
    if (rb) ro.observe(rb);
  }

  window.addEventListener("resize", scheduleChartResize);
  window.addEventListener("orientationchange", scheduleChartResize);
    if (window.visualViewport){
      visualViewport.addEventListener("resize", scheduleChartResize);
      visualViewport.addEventListener("scroll", scheduleChartResize);
    }
};
  const createChartsIfNeeded = () => {
    if (chartTotal || chartDaily) return;

    // If Chart.js is blocked (adblock/network), don't break the app.
    if (!window.Chart){
      const box = $("chartsBox");
      if (box) box.classList.add("hidden");
      return;
    }

    const c1 = $("chartTotal");
    const c2 = $("chartDaily");
    if (!c1 || !c2) return;

    try{
      Chart.defaults.animation = false;

      chartTotal = new Chart(c1, {
        type: "line",
        data: { 
          labels: [], 
          datasets: [{
            label: "Ï¥ùÏï°",
            data: [],
            tension: 0.25,
            pointRadius: 2,
            fill: true,
            backgroundColor: "rgba(165,180,252,.25)",
            borderColor: "rgba(129,140,248,.9)"
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => ` ${fmtKRW(ctx.parsed.y)}` } }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { ticks: { callback: (v) => shortKRW(v) } }
          }
        }
      });

      chartDaily = new Chart(c2, {
        type: "line",
        data: { 
          labels: [], 
          datasets: [{
            label: "ÎàÑÏ†Å Î≥ÄÎèôÎ•†",
            data: [],
            tension: 0.25,
            pointRadius: 2,
            fill: true,
            backgroundColor: "rgba(153,246,228,.25)",
            borderColor: "rgba(16,185,129,.85)"
          }] 
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => ` ${fmtPct(ctx.parsed.y)}` } }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { ticks: { callback: (v) => `${(v*100).toFixed(0)}%` } }
          }
        }
      });

      scheduleChartResize();
    }catch(_){
      const box = $("chartsBox");
      if (box) box.classList.add("hidden");
      chartTotal = null;
      chartDaily = null;
    }
  };

  const updateCharts = () => {
    createChartsIfNeeded();
    if (!chartTotal || !chartDaily) return;

    const asc = sortEntriesAsc(entries);
    const labels = asc.map(e => e.date);
    const totals = asc.map(e => e.totalKrw);

    const cumPct = [];
    const first = asc[0]?.totalKrw;
    for (let i=0;i<asc.length;i++){
      const cur = asc[i].totalKrw;
      if (!first) cumPct.push(null);
      else cumPct.push(i===0 ? 0 : (cur/first - 1));
    }

    chartTotal.data.labels = labels;
    chartTotal.data.datasets[0].data = totals;
    chartTotal.update();

    chartDaily.data.labels = labels;
    chartDaily.data.datasets[0].data = cumPct;
    chartDaily.update();
  };

  /*****************
   * Render table + KPIs
   *****************/
  const render = () => {
    updateKpis();
    renderTable();
    updateCharts();
    scheduleChartResize();
  };

  const updateKpis = () => {
    const asc = sortEntriesAsc(entries);
    const latest = asc[asc.length-1];
    const first = asc[0];

    if (!latest){
      $("kpiTotal").textContent = "‚Äî";
      $("kpiDate").textContent = "‚Äî";
      $("kpiDelta").textContent = "‚Äî";
      $("kpiDeltaPct").textContent = "‚Äî";
      $("kpiCum").textContent = "‚Äî";
      $("kpiCumPct").textContent = "‚Äî";
      return;
    }

    $("kpiTotal").textContent = fmtKRW(latest.totalKrw);
    $("kpiDate").textContent = latest.date;

    if (asc.length >= 2){
      const prev = asc[asc.length-2];
      const delta = latest.totalKrw - prev.totalKrw;
      const pct = prev.totalKrw ? delta / prev.totalKrw : NaN;

      $("kpiDelta").textContent = (delta>=0 ? "+" : "") + fmtKRW(delta).replace("Ïõê","") + "Ïõê";
      $("kpiDeltaPct").textContent = fmtPct(pct);

      $("kpiDelta").style.color = delta >= 0 ? "var(--ok)" : "var(--bad)";
      $("kpiDeltaPct").style.color = delta >= 0 ? "var(--ok)" : "var(--bad)";
    } else {
      $("kpiDelta").textContent = "‚Äî";
      $("kpiDeltaPct").textContent = "‚Äî";
      $("kpiDelta").style.color = "";
      $("kpiDeltaPct").style.color = "";
    }

    const cum = latest.totalKrw - first.totalKrw;
    const cumPct = first.totalKrw ? cum / first.totalKrw : NaN;
    $("kpiCum").textContent = (cum>=0 ? "+" : "") + fmtKRW(cum).replace("Ïõê","") + "Ïõê";
    $("kpiCumPct").textContent = fmtPct(cumPct);
    $("kpiCum").style.color = cum >= 0 ? "var(--ok)" : "var(--bad)";
    $("kpiCumPct").style.color = cum >= 0 ? "var(--ok)" : "var(--bad)";
  };

  const renderTable = () => {
    const tb = $("tbody");
    const asc = sortEntriesAsc(entries);
    const desc = sortEntriesDesc(entries);

    if (!desc.length){
      tb.innerHTML = `<tr><td colspan="8" class="muted">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</td></tr>`;
      return;
    }

    const firstTotal = asc[0].totalKrw;

    const byDatePrev = new Map();
    for (let i=0;i<asc.length;i++){
      byDatePrev.set(asc[i].date, i>0 ? asc[i-1] : null);
    }

    tb.innerHTML = "";
    for (const e of desc){
      const prev = byDatePrev.get(e.date);
      const delta = prev ? (e.totalKrw - prev.totalKrw) : NaN;
      const deltaPct = prev && prev.totalKrw ? delta / prev.totalKrw : NaN;
      const cumPct = firstTotal ? (e.totalKrw / firstTotal - 1) : NaN;

      const fxTxt = (Number.isFinite(e.fx) ? fmtFX(e.fx) : "‚Äî");

      const holdingsDetails = buildHoldingsDetails(e);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="pill">${e.date}</span></td>
        <td class="num">${fmtKRW(e.totalKrw)}</td>
        <td class="num">${Number.isFinite(delta) ? `${delta>=0?"+":""}${fmtKRW(delta).replace("Ïõê","")}Ïõê` : "‚Äî"}</td>
        <td class="num">${fmtPct(deltaPct)}</td>
        <td class="num">${fmtPct(cumPct)}</td>
        <td class="num">${fxTxt}</td>
        <td>${holdingsDetails}</td>
        <td class="num">
          <div class="inline-actions">
            <button class="mini" data-act="edit" data-date="${e.date}">Ìé∏Ïßë</button>
            <button class="mini danger" data-act="del" data-date="${e.date}">ÏÇ≠Ï†ú</button>
          </div>
        </td>
      `;
      // colorize delta
      const deltaCell = tr.children[2];
      const pctCell = tr.children[3];
      if (Number.isFinite(delta)){
        const good = delta >= 0;
        deltaCell.style.color = good ? "var(--ok)" : "var(--bad)";
        pctCell.style.color = good ? "var(--ok)" : "var(--bad)";
      }

      tr.querySelector('[data-act="edit"]').addEventListener("click", () => startEdit(e.date));
      tr.querySelector('[data-act="del"]').addEventListener("click", () => deleteEntry(e.date));
      tb.appendChild(tr);
    }
  };

  const buildHoldingsDetails = (entry) => {
    const n = entry.holdings?.length ?? 0;
    if (!n) return `<span class="muted">‚Äî</span>`;
    const lines = entry.holdings.map(h => {
      const where = escapeHtml(h.where || "ÎØ∏ÏßÄÏ†ï");
      const amt = Number.isFinite(h.amount) ? h.amount : 0;
      if (h.ccy === "KRW"){
        return `<li>${where}: ${escapeHtml(nf.format(amt))} KRW</li>`;
      }
      const krw = Number.isFinite(entry.fx) ? (amt * entry.fx) : NaN;
      const krwTxt = Number.isFinite(krw) ? ` (‚âà ${escapeHtml(nf.format(Math.round(krw)))} KRW)` : "";
      return `<li>${where}: ${escapeHtml(nf.format(amt))} USDT${krwTxt}</li>`;
    }).join("");

    return `
      <details>
        <summary>${n}Í∞ú Ìï≠Î™©</summary>
        <ul class="holdings-list">${lines}</ul>
      </details>
    `;
  };

  /*****************
   * CRUD
   *****************/
  const upsertEntry = (entry) => {
    const idx = entries.findIndex(e => e.date === entry.date);
    if (idx >= 0) entries[idx] = entry;
    else entries.push(entry);
    entries = sortEntriesAsc(entries);
  };

  const deleteEntry = (dateStr) => {
    if (!confirm(`${dateStr} Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?`)) return;
    entries = entries.filter(e => e.date !== dateStr);
    if (editDate === dateStr) resetForm();
    save();
    render();
  };

  const startEdit = (dateStr) => {
    const e = entries.find(x => x.date === dateStr);
    if (!e) return;
    editDate = dateStr;
    $("date").value = e.date;
    $("date").disabled = true;
    $("fx").value = Number.isFinite(e.fx) ? String(e.fx) : "";
    setHoldingsToUI(e.holdings);
    $("cancelEditBtn").classList.remove("hidden");
    $("saveBtn").textContent = "ÏàòÏ†ï Ï†ÄÏû•";
    updateTotalPreview();
  };

  const resetForm = () => {
    editDate = null;
    $("date").disabled = false;
    $("date").value = kstTodayStr();
    $("fx").value = "";
    setHoldingsToUI([{where:"", ccy:"KRW", amount:""}]);
    $("cancelEditBtn").classList.add("hidden");
    $("saveBtn").textContent = "Ï†ÄÏû•";
    updateTotalPreview();
  };

  const buildEntryFromForm = async () => {
    const dateStr = $("date").value;
    if (!dateStr) throw new Error("ÎÇ†ÏßúÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.");

    const holdings = getHoldingsFromUI();
    if (!holdings.length) throw new Error("ÏòàÏπò ÌòÑÌô©Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.");

    const needFx = holdingsNeedFx(holdings);
    let fx = null;

    if (needFx){
      const fxManual = parseNum($("fx").value);
      if (Number.isFinite(fxManual) && fxManual > 0){
        fx = fxManual;
      } else if (Number.isFinite(fxCache[dateStr])) {
        fx = fxCache[dateStr];
      } else {
        fx = await getUpbitUsdtKrwClose(dateStr);
      }
      fxCache[dateStr] = fx;
      $("fx").value = String(fx);
    }

    const totalKrw = computeTotalKrw(holdings, needFx ? fx : 1);
    if (!Number.isFinite(totalKrw)) throw new Error("Ï¥ùÏï° Í≥ÑÏÇ∞ Ïã§Ìå®");
    return { date: dateStr, fx: needFx ? fx : null, holdings, totalKrw };
  };

  /*****************
   * Persistence + Migration
   *****************/
  const save = () => {
    const payload = { version: 4, savedAt: new Date().toISOString(), entries, fxCache };
    localStorage.setItem(STORAGE_KEY_V4, JSON.stringify(payload));
  };

  const tryLoadV4 = () => {
    const raw = localStorage.getItem(STORAGE_KEY_V4);
    if (!raw) return false;
    try{
      const obj = JSON.parse(raw);
      if (!obj || !Array.isArray(obj.entries)) return false;
      entries = obj.entries.filter(e => e && typeof e.date === "string")
        .map(e => ({
          date: e.date,
          fx: Number.isFinite(Number(e.fx)) ? Number(e.fx) : null,
          holdings: Array.isArray(e.holdings) ? e.holdings.map(h => ({
            where: clampStr(h?.where ?? "ÎØ∏ÏßÄÏ†ï", 60),
            ccy: h?.ccy === "USDT" ? "USDT" : "KRW",
            amount: Number(h?.amount)
          })).filter(h => Number.isFinite(h.amount) && h.amount !== 0) : [],
          totalKrw: Number(e.totalKrw)
        }))
        .filter(e => e.holdings.length && Number.isFinite(e.totalKrw));
      fxCache = (obj.fxCache && typeof obj.fxCache === "object") ? obj.fxCache : {};
      entries = sortEntriesAsc(entries);
      return true;
    }catch(_){
      return false;
    }
  };

  const migrateLegacy = () => {
    // Best-effort: v3 allocations -> holdings; if none, value -> single holding
    for (const k of LEGACY_KEYS){
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      try{
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.entries)) continue;

        const migrated = [];
        const newFxCache = {};

        for (const e of obj.entries){
          if (!e || typeof e.date !== "string") continue;
          const date = e.date;

          const currency = (e.currency === "USDT" ? "USDT" : "KRW");
          const fx = Number.isFinite(Number(e.fx)) ? Number(e.fx) : null;

          const allocs = Array.isArray(e.allocations) ? e.allocations : [];
          let holdings = [];
          if (allocs.length){
            holdings = allocs.map(a => ({
              where: clampStr(a?.where ?? "ÎØ∏ÏßÄÏ†ï", 60),
              ccy: currency,
              amount: Number(a?.amount)
            })).filter(h => Number.isFinite(h.amount) && h.amount !== 0);
          } else {
            // fallback: use value as single holding
            const val = Number(e.value);
            if (Number.isFinite(val) && val !== 0){
              holdings = [{ where: "ÎØ∏ÏßÄÏ†ï", ccy: currency, amount: val }];
            }
          }
          if (!holdings.length) continue;

          const needFx = holdingsNeedFx(holdings);
          const useFx = needFx ? (Number.isFinite(fx) ? fx : null) : null;

          const totalKrw = computeTotalKrw(holdings, needFx ? useFx : 1);
          if (!Number.isFinite(totalKrw)) {
            // If USDT but fx missing, skip for now; user can re-enter.
            continue;
          }
          migrated.push({ date, fx: needFx ? useFx : null, holdings, totalKrw });
          if (needFx && Number.isFinite(useFx)) newFxCache[date] = useFx;
        }

        if (migrated.length){
          entries = sortEntriesAsc(migrated);
          fxCache = newFxCache;
          save();
          return true;
        }
      }catch(_){}
    }
    return false;
  };

  /*****************
   * Handlers
   *****************/
  $("addHoldingBtn").addEventListener("click", () => {
    holdingsEl.appendChild(holdingRowTemplate({}));
    updateFxVisibility();
    updateTotalPreview();
  });

  $("fxBtn").addEventListener("click", async () => {
    const dateStr = $("date").value;
    if (!dateStr) return;
    await ensureFxForDateIfNeeded(dateStr, true);
  });

  $("date").addEventListener("change", async () => {
    // If cached fx exists for date, auto-fill.
    const d = $("date").value;
    if (Number.isFinite(fxCache[d])) $("fx").value = String(fxCache[d]);
    updateFxVisibility();
    await ensureFxForDateIfNeeded(d, false);
    updateTotalPreview();
  });

  $("fx").addEventListener("input", updateTotalPreview);

  $("saveBtn").addEventListener("click", async () => {
    try{
      $("saveBtn").disabled = true;
      const entry = await buildEntryFromForm();
      upsertEntry(entry);
      save();
      // Drive auto-save (best effort)
      try{ await driveUploadLocal(true); }catch(e){ toast("Drive Ï†ÄÏû• Ïã§Ìå®(Ïó∞Í≤∞ ÌïÑÏöî)", "bad", 2600); }
      render();
      resetForm();
      toast("Ï†ÄÏû• ÏôÑÎ£å", "ok");
    }catch(err){
      toast(err?.message ?? "Ï†ÄÏû• Ïã§Ìå®", "bad", 2600);
    }finally{
      $("saveBtn").disabled = false;
    }
  });

  $("cancelEditBtn").addEventListener("click", resetForm);
  $("resetFormBtn").addEventListener("click", resetForm);
  $("prevBtn").addEventListener("click", () => {
    const dateStr = $("date").value;
    if (!dateStr) return;
    const asc = sortEntriesAsc(entries);
    let prev = null;
    for (const e of asc){
      if (e.date < dateStr) prev = e;
      else break;
    }
    if (!prev){
      toast("Ïù¥Ï†Ñ Í∏∞Î°ù ÏóÜÏùå", "bad");
      return;
    }
    setHoldingsToUI(prev.holdings);
    // Do not copy previous day's fx; today's fx will be auto-fetched on save if needed.
    const cached = fxCache[dateStr];
    $("fx").value = Number.isFinite(cached) ? String(cached) : "";
    updateFxVisibility();
    updateTotalPreview();
    toast(`Î∂àÎü¨Ïò¥: ${prev.date}`, "ok");
  });


  $("clearAllBtn").addEventListener("click", () => {
    if (!confirm("Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
    entries = [];
    fxCache = {};
    editDate = null;
    localStorage.removeItem(STORAGE_KEY_V4);
    render();
    resetForm();
  });

  
  const importFromObject = (obj) => {
    if (!obj || !Array.isArray(obj.entries)) throw new Error("ÌòïÏãù Ïò§Î•ò");

    const imported = obj.entries.map(e => ({
      date: String(e.date),
      fx: Number.isFinite(Number(e.fx)) ? Number(e.fx) : null,
      holdings: Array.isArray(e.holdings) ? e.holdings.map(h => ({
        where: clampStr(h?.where ?? "ÎØ∏ÏßÄÏ†ï", 60),
        ccy: h?.ccy === "USDT" ? "USDT" : "KRW",
        amount: Number(h?.amount)
      })).filter(h => Number.isFinite(h.amount) && h.amount !== 0) : [],
      totalKrw: Number(e.totalKrw)
    })).filter(e => e.holdings.length);

    const rebuilt = [];
    const newFxCache = {};
    for (const e of imported){
      const needFx = holdingsNeedFx(e.holdings);
      const fx = needFx ? (Number.isFinite(e.fx) ? e.fx : null) : null;
      const total = computeTotalKrw(e.holdings, needFx ? fx : 1);
      if (!Number.isFinite(total)) continue;
      rebuilt.push({ date: e.date, fx, holdings: e.holdings, totalKrw: total });
      if (needFx && Number.isFinite(fx)) newFxCache[e.date] = fx;
    }

    if (!rebuilt.length) throw new Error("Í∞ÄÏ†∏Ïò¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
    entries = sortEntriesAsc(rebuilt);
    fxCache = newFxCache;
    save();
    render();
    resetForm();
  };

$("exportBtn").addEventListener("click", () => {
    const payload = { version: 4, exportedAt: new Date().toISOString(), entries, fxCache };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `invest-tracker-v4-${kstTodayStr()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("importBtn").addEventListener("click", () => $("importFile").click());

  $("importFile").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    ev.target.value = "";
    if (!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      importFromObject(obj);
      toast("Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å", "ok");
    }catch(err){
      toast(err?.message ?? "Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®", "bad", 2600);
    }
  });

  /*****************
   * Init
   *****************/
  
  $("toastBackdrop")?.addEventListener("click", () => {
    const el = $("toast");
    const bd = $("toastBackdrop");
    window.clearTimeout(toast._t);
    window.clearTimeout(toast._t2);
    if (el){ el.classList.remove("show"); el.classList.add("hidden"); }
    if (bd){ bd.classList.remove("show"); bd.classList.add("hidden"); }
  });

const init = async () => {
    loadDriveCfg();
    bindDriveUI();
    refreshDriveUI();
    // Default UI
    $("date").value = kstTodayStr();
    setHoldingsToUI([{where:"", ccy:"KRW", amount:""}]);
    updateFxVisibility();
    await ensureFxForDateIfNeeded($("date").value, false);
    updateTotalPreview();

    // Load
    const loaded = tryLoadV4() || migrateLegacy();
    if (loaded) render();
    else render(); // empty

    // Auto connect + auto load (best effort)
    await autoDriveBootstrap();
    render();

// Force charts to resize on window resize (desktop split/resize edge cases)
window.addEventListener("resize", () => {
  try{
    if (typeof chartTotal?.resize === "function") chartTotal.resize();
    if (typeof chartDaily?.resize === "function") chartDaily.resize();
  }catch(_){}
});
  };

  init();
})();
</script>
</body>
</html>
